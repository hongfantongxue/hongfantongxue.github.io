<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  
  
  
  <meta name="description" content="记录技术点滴">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    
    个人博客</title>
  
  <link rel="shortcut icon" href="/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <main class="content">
    <section class="jumbotron">
  <div class="video">
    
    <div class="video-frame">
      <img src="/images/ocean/overlay-hero.png" alt="Decorative image frame">
    </div>
    
    <div class="video-media">
      <video playsinline="" autoplay="" loop="" muted="" data-autoplay="" poster="/images/ocean/ocean.png"
        x5-video-player-type="h5">
        <source src="/images/ocean/ocean.mp4" type="video/mp4">
        <source src="/images/ocean/ocean.ogv" type="video/ogg">
        <source src="/images/ocean/ocean.webm" type="video/webm">
        <p>Your user agent does not support the HTML5 Video element.</p>
      </video>
      <div class="video-overlay"></div>
    </div>
    <div class="video-inner text-center text-white">
      <h1><a href="/">个人博客</a></h1>
      <p>博客</p>
      <div><img src="/images/hexo-inverted.svg" class="brand" alt="个人博客"></div>
    </div>
    <div class="video-learn-more">
      <a class="anchor" href="#landingpage"><i class="fe fe-mouse"></i></a>
    </div>
  </div>
</section>
<div id="landingpage">
  <section class="outer">
  <article class="articles">
    
    <h1 class="page-type-title"></h1>
    
    
    <article id="post-Flink基础-Window-Watermark" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2020/01/01/Flink%E5%9F%BA%E7%A1%80-Window-Watermark/">Flink基础-Window&amp;Watermark</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/01/Flink%E5%9F%BA%E7%A1%80-Window-Watermark/" class="article-date">
  <time datetime="2019-12-31T17:00:00.000Z" itemprop="datePublished">2020-01-01</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <h4 id="1-1-Flink-Window操作"><a href="#1-1-Flink-Window操作" class="headerlink" title="1.1.Flink Window操作"></a>1.1.Flink Window操作</h4><p>Flink任务Batch是Streaming的一个特例，因此Flink底层引擎是一个流式引擎，在上面实现了流处理和批处理。而Window就是从Streaming到Batch的桥梁</p>
<p>Window窗口就在一个无界流中设置起始位置和终止位置，让无界流变成有界流，并且在有界流中进行数据处理</p>
<p>Window操作常见的业务场景：统计过去一段时间、最近一些元素的数据指标</p>
<h4 id="1-2-Window窗口分类"><a href="#1-2-Window窗口分类" class="headerlink" title="1.2.Window窗口分类"></a>1.2.Window窗口分类</h4><p>Window窗口在无界流中设置起始位置和终止位置的方式可以有两种：</p>
<ul>
<li>根据时间设置</li>
<li>根据窗口数据量（count）设置</li>
</ul>
<p>根据窗口的类型划分：</p>
<ul>
<li>滚动窗口</li>
<li>滑动窗口</li>
</ul>
<p>根据数据流类型划分：</p>
<ul>
<li>Keyed Window：基于分组后的数据流之上做窗口操作</li>
<li>Global Window：基于未分组的数据流之上做窗口操作</li>
</ul>
<p>根据不同的组合方式，可以组合出来8种窗口类型：</p>
<ol>
<li><p>基于分组后的数据流上的时间滚动窗口</p>
</li>
<li><p>基于分组后的数据流上的时间滑动窗口</p>
</li>
<li><p>基于分组后的数据流上的count滚动窗口</p>
</li>
<li><p>基于分组后的数据流上的count滑动窗口</p>
</li>
<li><p>基于未分组的数据流上的时间滚动窗口</p>
</li>
<li><p>基于未分组的数据流上的时间滑动窗口</p>
</li>
<li><p>基于未分组的数据流上的count滚动窗口</p>
</li>
<li><p>基于未分组的数据流上的count滑动窗口</p>
</li>
</ol>
<p>当然我们也可以根据实际业务场景自定义Window，这就是Flink最大的优势：Window种类多，灵活</p>
<p>Time Window（基于时间的窗口）</p>
<p>Tumbling Window：滚动窗口，窗口之间没有数据重叠</p>
<p><img src="/img/image-20211025110303877.png" alt="image-20211025110303877"></p>
<p>Sliding Window：滑动窗口，窗口内的数据有重叠</p>
<p>在定义滑动窗口的时候，不只是要定义窗口大小，还要定义窗口的滑动间隔时间（每隔多久</p>
<p>滑动一次），如果滑动间隔时间=窗口大小=滚动窗口</p>
<p><img src="/img%5Cimage-20211025110356614.png" alt="image-20211025110356614"></p>
<p>另外还有会话窗口Session Window，此种一般不用</p>
<p><img src="/img%5Cimage-20211025172052343.png" alt="image-20211025172052343"></p>
<h4 id="1-3-窗口聚合函数"><a href="#1-3-窗口聚合函数" class="headerlink" title="1.3.窗口聚合函数"></a>1.3.窗口聚合函数</h4><p>窗口函数定义了针对窗口内元素的计算逻辑，窗口函数大概分为两类：</p>
<ol>
<li>增量聚合函数，聚合原理：窗口内保存一个中间聚合结果，随着新元素的加入，不断对该值进行更新</li>
</ol>
<p>​    这类函数通常非常节省空间 ReduceFunction、AggregateFunction属于增量聚合函数</p>
<ol start="2">
<li>全量聚合函数，聚合原理：收集窗口内的所有元素，并且在执行的时候对他们进行遍历，这种聚合函数通常需要占用更多的空间（收集一段时间的数据并且保存），但是它可以支持更复杂的逻辑ProcessWindowFunction、WindowFunction属于全量窗口函数</li>
</ol>
<p>注意：这两类函数可以组合搭配使用</p>
<h5 id="1-3-1-增量聚合函数"><a href="#1-3-1-增量聚合函数" class="headerlink" title="1.3.1.增量聚合函数"></a>1.3.1.增量聚合函数</h5><h6 id="案例一-使用增量聚合函数统计最近5s内，各个卡口的车流量"><a href="#案例一-使用增量聚合函数统计最近5s内，各个卡口的车流量" class="headerlink" title="案例一:使用增量聚合函数统计最近5s内，各个卡口的车流量"></a>案例一:使用增量聚合函数统计最近5s内，各个卡口的车流量</h6><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.<span class="type">StringUtils</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.&#123;<span class="type">ProcessWindowFunction</span>, <span class="type">WindowFunction</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingProcessingTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用增量聚合函数统计最近5s内，各个卡口的车流量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">StatisCarFlow</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;StatisCarFlow&quot;</span>)</span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;traffic_info&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props).setStartFromEarliest())</span><br><span class="line">      .filter(line =&gt; <span class="type">StringUtils</span>.isNotEmpty(line) &amp;&amp; !line.equals(<span class="string">&quot;None&quot;</span>))</span><br><span class="line">      .map(line =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">1</span>), <span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      ).keyBy(_._1).window(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">5</span>)))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">AggregateFunction</span>[(<span class="type">String</span>, <span class="type">Int</span>), <span class="type">Int</span>, <span class="type">Int</span>]() &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(value: (<span class="type">String</span>, <span class="type">Int</span>), accumulator: <span class="type">Int</span>): <span class="type">Int</span> = accumulator + value._2</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(accumulator: <span class="type">Int</span>): <span class="type">Int</span> = accumulator</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(a: <span class="type">Int</span>, b: <span class="type">Int</span>): <span class="type">Int</span> = a + b</span><br><span class="line">      &#125;,</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ProcessWindowFunction、WindowFunction区别在于ProcessWindowFunction可以获取Flink执行的</span></span><br><span class="line"><span class="comment">         * 上下文，可以拿到当前的数据更多信息，比如窗口状态、窗口起始与终止时间、当前水印、时间戳等</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//        new WindowFunction[Int, (String, Int), String, TimeWindow] &#123;</span></span><br><span class="line">        <span class="comment">//          override def apply(key: String, window: TimeWindow, input: Iterable[Int], out: Collector[(String, Int)]): Unit = &#123;</span></span><br><span class="line">        <span class="comment">//            for (elem &lt;- input) &#123;</span></span><br><span class="line">        <span class="comment">//               out.collect((key, elem))</span></span><br><span class="line">        <span class="comment">//            &#125;</span></span><br><span class="line">        <span class="comment">//          &#125;</span></span><br><span class="line">        <span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">new</span> <span class="type">ProcessWindowFunction</span>[<span class="type">Int</span>, (<span class="type">String</span>, <span class="type">Int</span>), <span class="type">String</span>, <span class="type">TimeWindow</span>] &#123;</span><br><span class="line">          <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[<span class="type">Int</span>], out: <span class="type">Collector</span>[(<span class="type">String</span>, <span class="type">Int</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">            <span class="keyword">for</span> (elem &lt;- elements) &#123;</span><br><span class="line">              out.collect((key, elem))</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ).print()</span><br><span class="line">    env.execute(<span class="type">StatisCarFlow</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="案例二-每隔10s统计每辆汽车的平均速度"><a href="#案例二-每隔10s统计每辆汽车的平均速度" class="headerlink" title="案例二:每隔10s统计每辆汽车的平均速度"></a>案例二:每隔10s统计每辆汽车的平均速度</h6><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.<span class="type">StringUtils</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingProcessingTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每隔10s统计每辆汽车的平均速度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Demo02SpeedAVG</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;StatisCarFlow&quot;</span>)</span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;traffic_info&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props).setStartFromEarliest())</span><br><span class="line">      .filter(line =&gt; <span class="type">StringUtils</span>.isNotEmpty(line) &amp;&amp; !line.equals(<span class="string">&quot;None&quot;</span>))</span><br><span class="line">      .map(line =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">3</span>), strings(<span class="number">4</span>).toDouble)</span><br><span class="line">      &#125;</span><br><span class="line">      ).keyBy(_._1).window(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">AggregateFunction</span>[(<span class="type">String</span>, <span class="type">Double</span>), (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>), (<span class="type">String</span>, <span class="type">Double</span>)] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>) = (<span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(value: (<span class="type">String</span>, <span class="type">Double</span>), accumulator: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>)): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>) = (value._1, accumulator._2 + value._2, accumulator._3 + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(accumulator: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>)): (<span class="type">String</span>, <span class="type">Double</span>) = (accumulator._1, accumulator._2 / accumulator._3)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(a: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>), b: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>)): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>) = (a._1, a._2 + b._2, a._3 + b._3)</span><br><span class="line">      &#125;).print()</span><br><span class="line">    env.execute(<span class="type">Demo02SpeedAVG</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="1-3-2-全量聚合函数"><a href="#1-3-2-全量聚合函数" class="headerlink" title="1.3.2.全量聚合函数"></a>1.3.2.全量聚合函数</h5><h6 id="案例三-每隔10s对窗口内所有汽车的车速进行排序"><a href="#案例三-每隔10s对窗口内所有汽车的车速进行排序" class="headerlink" title="案例三:每隔10s对窗口内所有汽车的车速进行排序"></a>案例三:每隔10s对窗口内所有汽车的车速进行排序</h6><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.<span class="type">StringUtils</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessAllWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingProcessingTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每隔10s对窗口内所有汽车的车速进行排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Demo03SortSpeed</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;StatisCarFlow&quot;</span>)</span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;traffic_info&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props).setStartFromEarliest())</span><br><span class="line">      .filter(line =&gt; <span class="type">StringUtils</span>.isNotEmpty(line) &amp;&amp; !line.equals(<span class="string">&quot;None&quot;</span>))</span><br><span class="line">      .map(line =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">1</span>), strings(<span class="number">4</span>).toDouble)</span><br><span class="line">      &#125;).windowAll(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      <span class="comment">// 注意：想要全局排序并行度需要设置为1</span></span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">ProcessAllWindowFunction</span>[(<span class="type">String</span>, <span class="type">Double</span>), (<span class="type">String</span>, <span class="type">Double</span>), <span class="type">TimeWindow</span>] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">String</span>, <span class="type">Double</span>)], out: <span class="type">Collector</span>[(<span class="type">String</span>, <span class="type">Double</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">          <span class="keyword">val</span> list = elements.toList.sortBy(_._2)</span><br><span class="line">          <span class="keyword">for</span> (ele &lt;- list) &#123;</span><br><span class="line">            out.collect(ele._1, ele._2)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).print()</span><br><span class="line">    env.execute(<span class="type">Demo03SortSpeed</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="案例四-每隔10s统计出窗口内所有车辆的最大及最小速度"><a href="#案例四-每隔10s统计出窗口内所有车辆的最大及最小速度" class="headerlink" title="案例四:每隔10s统计出窗口内所有车辆的最大及最小速度"></a>案例四:每隔10s统计出窗口内所有车辆的最大及最小速度</h6><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.<span class="type">StringUtils</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessAllWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingProcessingTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每隔10s统计出窗口内所有车辆的最大及最小速度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Demo04MaxMinSpeed</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;StatisCarFlow&quot;</span>)</span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;traffic_info&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props).setStartFromEarliest())</span><br><span class="line">      .filter(line =&gt; <span class="type">StringUtils</span>.isNotEmpty(line) &amp;&amp; !line.equals(<span class="string">&quot;None&quot;</span>))</span><br><span class="line">      .map(line =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">1</span>), strings(<span class="number">4</span>).toDouble)</span><br><span class="line">      &#125;</span><br><span class="line">      ).windowAll(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">ProcessAllWindowFunction</span>[(<span class="type">String</span>, <span class="type">Double</span>), <span class="type">String</span>, <span class="type">TimeWindow</span>] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">String</span>, <span class="type">Double</span>)], out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">          <span class="keyword">val</span> list = elements.toList.sortBy(_._2)</span><br><span class="line">          <span class="keyword">val</span> minSpeed = list.head</span><br><span class="line">          <span class="keyword">val</span> maxSpeed = list.last</span><br><span class="line">          <span class="keyword">val</span> startWindowTime = context.window.getStart</span><br><span class="line">          <span class="keyword">val</span> endWindowTime = context.window.getEnd</span><br><span class="line">          out.collect(<span class="string">s&quot;minSpeed:<span class="subst">$minSpeed</span>,maxSpeed:<span class="subst">$maxSpeed</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).print()</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="type">Demo04MaxMinSpeed</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-4-Flink-Time时间语义"><a href="#1-4-Flink-Time时间语义" class="headerlink" title="1.4.Flink Time时间语义"></a>1.4.Flink Time时间语义</h4><p>Flink定义了三类时间</p>
<ul>
<li>处理时间（Process Time）数据进入Flink被处理的系统时间（Operator处理数据的系统时间）</li>
<li>事件时间（Event Time）数据在数据源产生的时间，一般由事件中的时间戳描述，比如用户日志中的TimeStamp</li>
<li>摄取时间（Ingestion Time）数据进入Flink的时间，记录被Source节点观察到的系统时间</li>
</ul>
<p><img src="/img%5Cimage-20211025150546185.png" alt="image-20211025150546185"></p>
<p>Flink流式计算的时候需要显示定义时间语义，根据不同的时间语义来处理数据，比如指定的时间语义是</p>
<p>事件时间，那么我们就要切换到事件时间的世界观中，窗口的起始与终止时间都是以事件时间为依据</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置时间语义为Ingestion Time </span></span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">IngestionTime</span>)</span><br><span class="line"><span class="comment">// 设置时间语义为Event Time 我们还需要指定一下数据中哪个字段是事件时间</span></span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br></pre></td></tr></table></figure>

<h5 id="1-4-1-基于事件时间的Window操作"><a href="#1-4-1-基于事件时间的Window操作" class="headerlink" title="1.4.1.基于事件时间的Window操作"></a>1.4.1.基于事件时间的Window操作</h5><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.eventtime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于事件时间的Window操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">EventTimeWindow</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.assignAscendingTimestamps(data =&gt; &#123;</span><br><span class="line">      data.split(<span class="string">&quot;,&quot;</span>)(<span class="number">0</span>).toLong</span><br><span class="line">    &#125;)</span><br><span class="line">      .flatMap(x =&gt; x.split(<span class="string">&quot;,&quot;</span>).tail).map((_, <span class="number">1</span>)).keyBy(_._1)</span><br><span class="line">      .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123;</span><br><span class="line">        (v1._1, v1._2 + v2._2)</span><br><span class="line">      &#125;)</span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">EventTimeWindow</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-5-Watermark"><a href="#1-5-Watermark" class="headerlink" title="1.5. Watermark"></a>1.5. Watermark</h4><h5 id="1-5-1-Watermark介绍"><a href="#1-5-1-Watermark介绍" class="headerlink" title="1.5.1. Watermark介绍"></a>1.5.1. Watermark介绍</h5><p>官网地址:</p>
<p><a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_timestamps_watermarks.html#writing-a-periodic-watermarkgenerator">https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_timestamps_watermarks.html#writing-a-periodic-watermarkgenerator</a></p>
<p>Watermark本质就是时间戳,在使用Flink处理数据的时候，数据通常都是按照事件产生的时间（事件时间）的顺序进入到Flink，但是在遇到特殊情况下，比如遇到网络延迟或者使用Kafka（多分区） 很难保证数据都是按照事件时间的顺序进入Flink，很有可能是乱序进入。</p>
<p>如果使用的是事件时间这个语义，数据一旦是乱序进入，那么在使用Window处理数据的时候，就会出现延迟数据不会被计算的问题</p>
<p><img src="/img%5Cimage-20211027092324003.png" alt="image-20211027092324003"></p>
<p><img src="/img%5Cimage-20211027092703537.png" alt="image-20211027092703537"></p>
<p>举例： Window窗口长度10s，滚动窗口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">001 zs 2020-04-25 10:00:01</span><br><span class="line">001 zs 2020-04-25 10:00:02</span><br><span class="line">001 zs 2020-04-25 10:00:03</span><br><span class="line">001 zs 2020-04-25 10:00:11 窗口触发执行</span><br><span class="line">001 zs 2020-04-25 10:00:05 延迟数据，不会被上一个窗口所计算导致计算结果不正确</span><br></pre></td></tr></table></figure>

<p>Watermark+Window可以很好的解决延迟数据的问题</p>
<p>Flink窗口计算的过程中，如果数据全部到达就会到窗口中的数据做处理，如果有延迟数据，那么窗口需要等待全部的数据到来之后，再触发窗口执行，需要等待多久？不可能无限期等待，我们用户可以自己来设置延迟时间这样就可以<strong>尽可能</strong>保证延迟数据被处理</p>
<p>根据用户指定的延迟时间生成水印（Watermak = 最大事件时间-指定延迟时间）</p>
<p>当Watermak 大于等于窗口的停止时间，这个窗口就会被触发执行</p>
<p>举例：Window窗口长度10s(01-10)，滚动窗口，指定延迟时间3s</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">01</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">09</span>:<span class="number">59</span>:<span class="number">58</span></span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>) </span><br><span class="line"><span class="keyword">val</span> stream = env.socketTextStream(<span class="string">&quot;node01&quot;</span>, <span class="number">8888</span>).assignAscendingTimestamps(data =&gt; &#123; </span><br><span class="line"><span class="keyword">val</span> splits = data.split(<span class="string">&quot; &quot;</span>) </span><br><span class="line">splits(<span class="number">0</span>).toLong </span><br><span class="line">&#125;)</span><br><span class="line">stream .flatMap(x=&gt;x.split(<span class="string">&quot; &quot;</span>).tail) .map((_, <span class="number">1</span>)) .keyBy(_._1) </span><br><span class="line"><span class="comment">// .timeWindow(Time.seconds(10)) </span></span><br><span class="line">.window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>))) </span><br><span class="line">.reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123; </span><br><span class="line">(v1._1, v1._2 + v2._2) </span><br><span class="line">&#125;).print() </span><br><span class="line">env.execute() </span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">09</span>:<span class="number">59</span>:<span class="number">59</span></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">03</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">09</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">06</span></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">12</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">09</span></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">08</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">05</span> 延迟数据</span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">13</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">10</span> 此时wm &gt;= window end time 触发窗口</span><br><span class="line">执行 处理的是事件时间<span class="number">01</span><span class="number">-10</span>的数据，并不是水印时间为<span class="number">01</span><span class="number">-10</span>的数据 **重点**</span><br><span class="line">讲道理，如果没有<span class="type">Watermark</span>在倒数第三条数据来的时候，就会触发执行，那么倒数第二条的延迟数据</span><br><span class="line">就不会被计算，那么有了水印可以处理延迟<span class="number">3</span>s内的数据</span><br></pre></td></tr></table></figure>

<p>注意：如果数据不会乱序进入Flink，没必要使用Watermark</p>
<p>代码演示</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.watermark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xyz.window.eventtime.<span class="type">EventTimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WatermarkDemo1</span></span><br><span class="line"><span class="comment"> * 测试数据</span></span><br><span class="line"><span class="comment">10000,hello,msb</span></span><br><span class="line"><span class="comment">14000,hello,flink</span></span><br><span class="line"><span class="comment">20000,hello,hadoop</span></span><br><span class="line"><span class="comment">21000,hello,bj</span></span><br><span class="line"><span class="comment">17000,hello,sh</span></span><br><span class="line"><span class="comment">23000,hello,jjj</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">WatermarkDemo1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[<span class="type">String</span>](<span class="type">Time</span>.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">String</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">        element.split(<span class="string">&quot;,&quot;</span>)(<span class="number">0</span>).toLong</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">      .flatMap(x =&gt; x.split(<span class="string">&quot;,&quot;</span>).tail).map((_, <span class="number">1</span>)).keyBy(_._1)</span><br><span class="line">      .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123;</span><br><span class="line">        (v1._1, v1._2 + v2._2)</span><br><span class="line">      &#125;)</span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">WatermarkDemo1</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-5-2-Watermark生产策略"><a href="#1-5-2-Watermark生产策略" class="headerlink" title="1.5.2. Watermark生产策略"></a>1.5.2. Watermark生产策略</h5><h6 id="周期性水印（Periodic-Watermark）"><a href="#周期性水印（Periodic-Watermark）" class="headerlink" title="周期性水印（Periodic Watermark）"></a>周期性水印（Periodic Watermark）</h6><p>根据事件或者处理时间周期性的触发水印生成器(Assigner)，默认100ms，每隔100毫秒自动向流里注入一个Watermark</p>
<p>代码案例一:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.watermark</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 周期性水印（Periodic Watermark）根据事件或者处理时间周期性的触发水印生成器(Assigner)</span></span><br><span class="line"><span class="comment"> * 默认100ms，每隔100毫秒自动向流里注入一个Watermark周期性水印API</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PeriodicWatermarkDemo1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    env.getConfig.setAutoWatermarkInterval(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[<span class="type">String</span>](<span class="type">Time</span>.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">String</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">        element.split(<span class="string">&quot;,&quot;</span>)(<span class="number">0</span>).toLong</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">      .flatMap(x =&gt; x.split(<span class="string">&quot;,&quot;</span>).tail).map((_, <span class="number">1</span>)).keyBy(_._1)</span><br><span class="line">      .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123;</span><br><span class="line">        (v1._1, v1._2 + v2._2)</span><br><span class="line">      &#125;)</span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">PeriodicWatermarkDemo1</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码案例二:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.watermark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">AssignerWithPeriodicWatermarks</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.watermark.<span class="type">Watermark</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 周期性水印自定义生成</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PeriodicWatermarkDemo2</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    env.getConfig.setAutoWatermarkInterval(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">MyTimestampAndWatermarks</span>(<span class="number">3000</span>))</span><br><span class="line">      .flatMap(x =&gt; x.split(<span class="string">&quot;,&quot;</span>).tail).map((_, <span class="number">1</span>)).keyBy(_._1)</span><br><span class="line">      .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123;</span><br><span class="line">        (v1._1, v1._2 + v2._2)</span><br><span class="line">      &#125;)</span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">PeriodicWatermarkDemo2</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyTimestampAndWatermarks</span>(<span class="params">delayTime: <span class="type">Long</span></span>) <span class="keyword">extends</span> <span class="title">AssignerWithPeriodicWatermarks</span>[<span class="type">String</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> maxCurrentWatermark: <span class="type">Long</span> = _</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 水印=最大事件时间-延迟时间 后被调用 水印是递增，小于上一个水印不会被发射出去</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getCurrentWatermark</span></span>: <span class="type">Watermark</span> = &#123;</span><br><span class="line">      <span class="comment">// 产生水印</span></span><br><span class="line">      <span class="keyword">new</span> <span class="type">Watermark</span>(maxCurrentWatermark - delayTime)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取当前的时间戳 先被调用</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">String</span>, recordTimestamp: <span class="type">Long</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> currentTimeStamp = element.split(<span class="string">&quot;,&quot;</span>)(<span class="number">0</span>).toLong</span><br><span class="line">      maxCurrentWatermark = math.max(currentTimeStamp, maxCurrentWatermark)</span><br><span class="line">      currentTimeStamp</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="间歇性水印（Punctuated-Watermark）"><a href="#间歇性水印（Punctuated-Watermark）" class="headerlink" title="间歇性水印（Punctuated Watermark）"></a>间歇性水印（Punctuated Watermark）</h6><p>在观察到事件后，会依据用户指定的条件来决定是否发射水印</p>
<p>比如，在车流量的数据中，001卡口通信经常异常，传回到服务器的数据会有延迟问题，其他的卡口都是正常的，那么这个卡口的数据需要打上水印</p>
<p>代码案例三:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.watermark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">ReduceFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">AssignerWithPunctuatedWatermarks</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.watermark.<span class="type">Watermark</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">001,10000</span></span><br><span class="line"><span class="comment">002,14000</span></span><br><span class="line"><span class="comment">002,20000</span></span><br><span class="line"><span class="comment">002,21000</span></span><br><span class="line"><span class="comment">001,17000</span></span><br><span class="line"><span class="comment">002,23000</span></span><br><span class="line"><span class="comment">001,23000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PunctuatedWatermarkDemo1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    env.getConfig.setAutoWatermarkInterval(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.map(line =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> arr = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">      (arr(<span class="number">0</span>), arr(<span class="number">1</span>).toLong)</span><br><span class="line">    &#125;)</span><br><span class="line">      .assignTimestampsAndWatermarks(<span class="keyword">new</span> myWatermark(<span class="number">3000</span>))</span><br><span class="line">      .map(value =&gt; &#123;</span><br><span class="line">        (value._1, <span class="number">1</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">      .keyBy(_._1).window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce(<span class="keyword">new</span> <span class="type">ReduceFunction</span>[(<span class="type">String</span>, <span class="type">Int</span>)] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">reduce</span></span>(value1: (<span class="type">String</span>, <span class="type">Int</span>), value2: (<span class="type">String</span>, <span class="type">Int</span>)): (<span class="type">String</span>, <span class="type">Int</span>) = (value1._1, value1._2 + value2._2)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">PunctuatedWatermarkDemo1</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">myWatermark</span>(<span class="params">delay: <span class="type">Long</span></span>) <span class="keyword">extends</span> <span class="title">AssignerWithPunctuatedWatermarks</span>[(<span class="type">String</span>, <span class="type">Long</span>)] </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> maxTimeStamp: <span class="type">Long</span> = _</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">checkAndGetNextWatermark</span></span>(elem: (<span class="type">String</span>, <span class="type">Long</span>), extractedTimestamp: <span class="type">Long</span>): <span class="type">Watermark</span> = &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;001&quot;</span>.equals(elem._1)) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="type">Watermark</span>(maxTimeStamp - delay)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: (<span class="type">String</span>, <span class="type">Long</span>), previousElementTimestamp: <span class="type">Long</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">      maxTimeStamp = math.max(element._2, maxTimeStamp)</span><br><span class="line">      element._2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-6-AllowedLateness"><a href="#1-6-AllowedLateness" class="headerlink" title="1.6.AllowedLateness"></a>1.6.AllowedLateness</h4><p>基于Event-Time的窗口处理流式数据，虽然提供了Watermark机制，却只能在一定程度上解决了数据乱序的问题。但在某些情况下数据可能延时会非常严重，即使通过Watermark机制也无法等到数据全部进入窗口再进行处理。Flink中默认会将这些迟到的数据做丢弃处理，但是有些时候用户希望即使数据延迟并不是很严重的情况下，也能继续窗口计算，不希望对于数据延迟比较严重的数据混入正常的计算流程中，此时就需要使用Allowed Lateness机制来对迟到的数据进行额外的处理。</p>
<p>举例：例如用户大屏数据展示系统，即使正常的窗口中没有将迟到的数据进行统计，但为了保证页面数据显示的连续性，后来接入到系统中迟到比较严重的数据所统计出来的结果不希望显示在屏幕上，而是将延时数据和结果存储到数据库中，便于后期对延时数据进行分析。对于这种情况需要借助Side Output来处理，通过使用sideOutputLateData（OutputTag）来标记迟到数据计算的结果，然后使用getSideOutput（lateOutputTag）从窗口结果中获取lateOutputTag标签对应的数据，之后转成独立的DataStream数据集进行处理，创建late-data的OutputTag，再通过该标签从窗口结果中将迟到数据筛选出来</p>
<p>Flink默认当窗口计算完毕后，窗口元素数据及状态会被清空，但是使用AllowedLateness，可以延迟清除窗口元素数据及状态，以便于当延迟数据到来的时候，能够重新计算当前窗口</p>
<p>代码案例</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.sideoutput</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessAllWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 问题1：使用AllowedLateness 方法是不是会降低flink计算的吞吐量？ 是的</span></span><br><span class="line"><span class="comment"> * 问题2：直接watermark设置为5 不是也可以代替这一通操作嘛？ 不能代替，watermark设置为5的</span></span><br><span class="line"><span class="comment"> * 话，允许延迟5s，每次处理过去5s的窗口数据，延迟比较高，如果使用这通操作，每次处理过去2s的数</span></span><br><span class="line"><span class="comment"> * 据，实时性比较高，当有新的延迟数据，即时计算，对于计算实时性比较高的场景还得使用这一通操作</span></span><br><span class="line"><span class="comment"> * 问题3：watermark（5s）+滑动窗口（滑动间隔2s）能够实现这通计算？ 不行</span></span><br><span class="line"><span class="comment"> * 案例：每隔5s统计各个卡口最近5s的车流量（滑动窗口），计算实时性小于2（ps：当10s的数据来</span></span><br><span class="line"><span class="comment"> * 了，8s之前的数据必须处理完），允许数据延迟5s，数据延迟超过5s的数据放入到侧输出流中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 10000 hello</span></span><br><span class="line"><span class="comment"> * 11000 spark</span></span><br><span class="line"><span class="comment"> * 14000 flink</span></span><br><span class="line"><span class="comment"> * 15000 hadoop 此时窗口并不会计算，因为Watermark设为2s 此时的watermark是13000 窗口范围 10000-15000</span></span><br><span class="line"><span class="comment"> * 17000 sqoop 此时窗口会被计算 默认：窗口计算完毕，窗口数据全部会被清空</span></span><br><span class="line"><span class="comment"> * 12000 flume 此时窗口重新计算（10000-15000），因为开启了AllowedLateness 3s，当 watermark&gt;=window end+ AllowedLateness 3s 窗口数据及状态才会被清除掉，</span></span><br><span class="line"><span class="comment"> * 此时的watermark 是15000 20000 scala 此时上一个窗口（10000-15000）的数据及状态会被清空 12000 hdfs 此时窗口不会重新计算</span></span><br><span class="line"><span class="comment"> * 因为现在watermark是18000&gt;=15000+3000,12000数据是迟到 非常严重的数据，会被放入到侧输出流中</span></span><br><span class="line"><span class="comment"> * 本来10000-15000的窗口，在15000的时候会计算，但是由于Watermark 的原因，等待了2s 17000的时 候才会计算，</span></span><br><span class="line"><span class="comment"> * 又因为AllowedLateness 3s的原因，10000-15000的窗口会被保存3s（注意这是 eventtime时间语义），直到20000出现，才会被删除，</span></span><br><span class="line"><span class="comment"> * 所以在20000没有出现之前，凡是事件时间在 10000-15000的数据都会重新进行窗口计算 超过5s的数据，称之为迟到非常严重的数据，放入到侧输出流 5s以内的数据，</span></span><br><span class="line"><span class="comment"> * 称之为迟到不严重的数据，窗口重新计算</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Allowlatest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> stream = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    <span class="keyword">val</span> lateTag = <span class="keyword">new</span> <span class="type">OutputTag</span>[(<span class="type">Long</span>, <span class="type">String</span>)](<span class="string">&quot;late&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> value = stream.map(x =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> strings = x.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">      (strings(<span class="number">0</span>).toLong, strings(<span class="number">1</span>))</span><br><span class="line">    &#125;).assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[(<span class="type">Long</span>, <span class="type">String</span>)](<span class="type">Time</span>.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: (<span class="type">Long</span>, <span class="type">String</span>)): <span class="type">Long</span> = element._1</span><br><span class="line">    &#125;).timeWindowAll(<span class="type">Time</span>.seconds(<span class="number">5</span>)).allowedLateness(<span class="type">Time</span>.seconds(<span class="number">3</span>)).sideOutputLateData(lateTag).process(<span class="keyword">new</span> <span class="type">ProcessAllWindowFunction</span>[(<span class="type">Long</span>, <span class="type">String</span>), (<span class="type">Long</span>, <span class="type">String</span>), <span class="type">TimeWindow</span>] &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">Long</span>, <span class="type">String</span>)], out: <span class="type">Collector</span>[(<span class="type">Long</span>, <span class="type">String</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">        println(context.window.getStart + <span class="string">&quot;---&quot;</span> + context.window.getEnd)</span><br><span class="line">        <span class="keyword">for</span> (elem &lt;- elements) &#123;</span><br><span class="line">          out.collect(elem)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    value.print(<span class="string">&quot;main&quot;</span>)</span><br><span class="line">    value.getSideOutput(lateTag).print(<span class="string">&quot;late&quot;</span>)</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-7-Flink关联维表实战"><a href="#1-7-Flink关联维表实战" class="headerlink" title="1.7.Flink关联维表实战"></a>1.7.Flink关联维表实战</h4><p>​    在Flink实际开发过程中，可能会遇到source 进来的数据，需要连接数据库里面的字段，再做后面的处理</p>
<p>比如，想要通过id获取对应的地区名字，这时候需要通过id查询地区维度表，获取具体的地区名对于不同的应用场景，关联维度表的方式不同</p>
<p>场景1：维度表信息基本不发生改变，或者发生改变的频率很低</p>
<p>实现方案：采用Flink提供的CachedFile</p>
<p>Flink提供了一个分布式缓存（CachedFile），类似于hadoop，可以使用户在并行函数中很方便的读取本地文件，并把它放在TaskManager节点中，防止task重复拉取。 此缓存的工作机制如下：</p>
<p>程序注册一个文件或者目录(本地或者远程文件系统，例如hdfs或者s3)，通过ExecutionEnvironment注册缓存文件并为它起一个名称。 当程序执行，Flink自动将文件或者目录复制到所有TaskManager节点的本地文件系统，仅会执行一次。用户可以通过这个指定的名称查找文件或者目录，然后从TaskManager节点的本地文件系统访问它</p>
<p>代码案例一</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.dimensiontable</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">RichMapFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">StreamExecutionEnvironment</span>, _&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">FileUtils</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DimensionTableDemo1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.registerCachedFile(<span class="string">&quot;D:\\tmp\\text01.txt&quot;</span>, <span class="string">&quot;id2city&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> socketStream = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    <span class="keyword">val</span> stream = socketStream.map(_.toInt)</span><br><span class="line">    stream.map(<span class="keyword">new</span> <span class="type">RichMapFunction</span>[<span class="type">Int</span>, <span class="type">String</span>] &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">val</span> id2CityMap = <span class="keyword">new</span> mutable.<span class="type">HashMap</span>[<span class="type">Int</span>, <span class="type">String</span>]()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">open</span></span>(parameters: <span class="type">Configuration</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> file = getRuntimeContext.getDistributedCache.getFile(<span class="string">&quot;id2city&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> str = <span class="type">FileUtils</span>.readFileUtf8(file)</span><br><span class="line">        <span class="keyword">val</span> strings = str.split(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> (str &lt;- strings) &#123;</span><br><span class="line">          <span class="keyword">val</span> splits = str.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">          <span class="keyword">val</span> id = splits(<span class="number">0</span>).toInt</span><br><span class="line">          <span class="keyword">val</span> city = splits(<span class="number">1</span>)</span><br><span class="line">          id2CityMap.put(id, city)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(value: <span class="type">Int</span>): <span class="type">String</span> = &#123;</span><br><span class="line">        id2CityMap.getOrElse(value, <span class="string">&quot;not found city&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).print()</span><br><span class="line">    env.execute()</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在集群中查看对应TaskManager的log日志，发现注册的fifile会被拉取到各个TaskManager的工作目录区</p>
<p><img src="/img%5Cimage-20211027145131283.png" alt="image-20211027145131283"></p>
<p>代码案例二:对于维度表更新频率比较高并且对于查询维度表的实时性要求比较高</p>
<p>实现方案：使用定时器，定时加载外部配置文件或者数据库</p>
<p>注意此种方式key对应的value值只允许增加和修改,不允许删除(如果删除对应的是key删除前对应的value值)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.dimensiontable</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">RichMapFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">StreamExecutionEnvironment</span>, _&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.&#123;<span class="type">Timer</span>, <span class="type">TimerTask</span>&#125;</span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable</span><br><span class="line"><span class="keyword">import</span> scala.io.<span class="type">Source</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DimensionTableDemo2</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> stream = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    stream.map(<span class="keyword">new</span> <span class="type">RichMapFunction</span>[<span class="type">String</span>, <span class="type">String</span>] &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">val</span> map = <span class="keyword">new</span> mutable.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>]()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">open</span></span>(parameters: <span class="type">Configuration</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        println(<span class="string">&quot;init data ...&quot;</span>)</span><br><span class="line">        query()</span><br><span class="line">        <span class="keyword">val</span> timer = <span class="keyword">new</span> <span class="type">Timer</span>(<span class="literal">true</span>)</span><br><span class="line">        timer.schedule(<span class="keyword">new</span> <span class="type">TimerTask</span> &#123;</span><br><span class="line">          <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">            query()</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//1s后，每隔2s执行一次</span></span><br><span class="line">        &#125;, <span class="number">1000</span>, <span class="number">2000</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">query</span></span>() = &#123;</span><br><span class="line">        <span class="keyword">val</span> source = <span class="type">Source</span>.fromFile(<span class="string">&quot;D:\\tmp\\text01.txt&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> iterator = source.getLines()</span><br><span class="line">        <span class="keyword">for</span> (elem &lt;- iterator) &#123;</span><br><span class="line">          <span class="keyword">val</span> vs = elem.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">          map.put(vs(<span class="number">0</span>), vs(<span class="number">1</span>))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(key: <span class="type">String</span>): <span class="type">String</span> = &#123;</span><br><span class="line">        map.getOrElse(key, <span class="string">&quot;not found city&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果维度信息在配置文件中存储，那么还有一个解决方案，就是使用readFile读取文件，因为这个方法可以检测内容是否发生改变</p>
<p>代码案例三：对于维度表更新频率高并且对于查询维度表的实时性要求高</p>
<p>实现方案：管理员在修改配置文件的时候，需要将更改的信息同步值Kafka配置Topic中，然后将kafka的配置流信息变成广播流，广播到业务流的各个线程中</p>
<p><img src="/img%5Cimage-20211027150523831.png" alt="image-20211027150523831"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.dimensiontable</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.<span class="type">MapStateDescriptor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.typeinfo.<span class="type">BasicTypeInfo</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.co.<span class="type">BroadcastProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">StreamExecutionEnvironment</span>, _&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.<span class="type">StringSerializer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DimensionTableDemo3</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">//设置连接kafka的配置信息</span></span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;flink-kafka-001&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;key.deserializer&quot;</span>, classOf[<span class="type">StringSerializer</span>].getName)</span><br><span class="line">    props.setProperty(<span class="string">&quot;value.deserializer&quot;</span>, classOf[<span class="type">StringSerializer</span>].getName)</span><br><span class="line">    <span class="keyword">val</span> consumer = <span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;configure&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props)</span><br><span class="line">    <span class="comment">//从topic最开始的数据读取</span></span><br><span class="line">    <span class="comment">//consumer.setStartFromEarliest()</span></span><br><span class="line">    <span class="comment">// 从最新的数据开始读取</span></span><br><span class="line">    consumer.setStartFromLatest()</span><br><span class="line">    <span class="comment">//动态配置信息流</span></span><br><span class="line">    <span class="keyword">val</span> configureStream = env.addSource(consumer)</span><br><span class="line">    <span class="comment">//业务流</span></span><br><span class="line">    <span class="keyword">val</span> busStream = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    <span class="keyword">val</span> descriptor = <span class="keyword">new</span> <span class="type">MapStateDescriptor</span>[<span class="type">String</span>, <span class="type">String</span>](<span class="string">&quot;dynamicConfig&quot;</span>, <span class="type">BasicTypeInfo</span>.<span class="type">STRING_TYPE_INFO</span>, <span class="type">BasicTypeInfo</span>.<span class="type">STRING_TYPE_INFO</span>)</span><br><span class="line">    <span class="comment">//设置广播流的数据描述信息</span></span><br><span class="line">    <span class="keyword">val</span> broadcastStream = configureStream.broadcast(descriptor)</span><br><span class="line">    <span class="comment">//connect关联业务流与配置信息流，broadcastStream流中的数据会广播到下游的各个线程中</span></span><br><span class="line">    busStream.connect(broadcastStream).process(<span class="keyword">new</span> <span class="type">BroadcastProcessFunction</span>[<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>] &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(line: <span class="type">String</span>, ctx: <span class="type">BroadcastProcessFunction</span>[<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>]#<span class="type">ReadOnlyContext</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> broadcast = ctx.getBroadcastState(descriptor)</span><br><span class="line">        <span class="keyword">val</span> city = broadcast.get(line)</span><br><span class="line">        <span class="keyword">if</span> (city == <span class="literal">null</span>) &#123;</span><br><span class="line">          out.collect(<span class="string">&quot;not found city&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          out.collect(city)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//kafka中配置流信息，写入到广播流中</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processBroadcastElement</span></span>(line: <span class="type">String</span>, ctx: <span class="type">BroadcastProcessFunction</span>[<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>]#<span class="type">Context</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> broadcast = ctx.getBroadcastState(descriptor)</span><br><span class="line">        <span class="comment">//kafka中的数据</span></span><br><span class="line">        <span class="keyword">val</span> elems = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        broadcast.put(elems(<span class="number">0</span>), elems(<span class="number">1</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/01/01/Flink%E5%9F%BA%E7%A1%80-Window-Watermark/" data-id="ckvl1q4la0006c9gh9qh207w4" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-scala基础02" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2019/07/05/scala%E5%9F%BA%E7%A1%8002/">scala基础02</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2019/07/05/scala%E5%9F%BA%E7%A1%8002/" class="article-date">
  <time datetime="2019-07-05T02:38:00.000Z" itemprop="datePublished">2019-07-05</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <h3 id="1-高阶函数"><a href="#1-高阶函数" class="headerlink" title="1.高阶函数"></a>1.高阶函数</h3><h4 id="1-1-基础使用"><a href="#1-1-基础使用" class="headerlink" title="1.1.基础使用"></a>1.1.基础使用</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//  函数定义方式一</span></span><br><span class="line"><span class="comment">//  val/var 函数名称 = （输入参数列表） =&gt; &#123;函数体&#125;</span></span><br><span class="line"><span class="keyword">val</span> f1 = (a: <span class="type">Int</span>, b: <span class="type">Int</span>) =&gt; a + b</span><br><span class="line">println(f1(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//  函数定义方式二</span></span><br><span class="line"><span class="comment">//  val/var 函数名称:(输入参数列表) =&gt; 返回值类型 = (输入参数的饮用) =&gt;&#123;函数体&#125;</span></span><br><span class="line"><span class="keyword">val</span> f2: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span> = (a: <span class="type">Int</span>, b: <span class="type">Int</span>) =&gt; a + b</span><br><span class="line"><span class="keyword">val</span> f3: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span> = (a, b) =&gt; a + b</span><br><span class="line">println(f3(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法的定义一</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sayHello</span></span>(name: <span class="type">String</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  println(<span class="string">s&quot;<span class="subst">$name</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法赋值给变量</span></span><br><span class="line"><span class="keyword">val</span> sayHelloFunc = sayHello _</span><br><span class="line">sayHelloFunc(<span class="string">&quot;zhangsan&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 高阶函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cal</span></span>(a: <span class="type">Int</span>, b: <span class="type">Int</span>, op: ((<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span>)): <span class="type">Int</span> = &#123;</span><br><span class="line">  op(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>) = x + y</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mulit</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>) = x * y</span><br><span class="line"></span><br><span class="line">println(cal(<span class="number">2</span>, <span class="number">3</span>, mulit))</span><br><span class="line">println(cal(<span class="number">2</span>, <span class="number">3</span>, _ + _))</span><br><span class="line"></span><br><span class="line"><span class="comment">// currying  柯里化 spark SQL 用的多</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum1</span></span>(a: <span class="type">Int</span>, b: <span class="type">Int</span>) = a + b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum2</span></span>(a: <span class="type">Int</span>)(b: <span class="type">Int</span>) = a + b</span><br><span class="line"></span><br><span class="line">println(sum1(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">println(sum2(<span class="number">1</span>)(<span class="number">2</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="1-2-自定义-map-filter-reduce-foreach"><a href="#1-2-自定义-map-filter-reduce-foreach" class="headerlink" title="1.2. 自定义 map filter reduce foreach"></a>1.2. 自定义 map filter reduce foreach</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义 map filter reduce foreach</span></span><br><span class="line">   <span class="keyword">val</span> array = <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">custom_map</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>], op: <span class="type">Int</span> =&gt; <span class="type">Int</span>) = &#123;</span><br><span class="line">     <span class="keyword">for</span> (ele &lt;- array) <span class="keyword">yield</span> op(ele)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   custom_map(array, _ * <span class="number">2</span>).foreach(println)</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">custom_filter</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>], op: <span class="type">Int</span> =&gt; <span class="type">Boolean</span>) = &#123;</span><br><span class="line">     <span class="keyword">for</span> (ele &lt;- array <span class="keyword">if</span> op(ele)) <span class="keyword">yield</span> ele</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   custom_filter(array, x =&gt; x % <span class="number">2</span> == <span class="number">0</span>).foreach(println)</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">custom_foreach</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>], op: <span class="type">Int</span> =&gt; <span class="type">Unit</span>) = &#123;</span><br><span class="line">     <span class="keyword">for</span> (ele &lt;- array) <span class="keyword">yield</span> op(ele)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   custom_foreach(array, println(_))</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">custom_reduce</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>], op: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span>) = &#123;</span><br><span class="line">     <span class="keyword">var</span> last = array(<span class="number">0</span>)</span><br><span class="line">     <span class="keyword">for</span> (i &lt;- <span class="number">1</span> until (array.length)) &#123;</span><br><span class="line">       last = op(last, array(i))</span><br><span class="line">     &#125;</span><br><span class="line">     last</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   println(custom_reduce(array, _ + _))</span><br><span class="line">   println(<span class="string">&quot;----------------------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// map</span></span><br><span class="line">   <span class="keyword">val</span> array1 = <span class="type">List</span>(<span class="type">Array</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">30</span>)), <span class="type">Array</span>((<span class="string">&quot;lisi&quot;</span>, <span class="number">18</span>)))</span><br><span class="line">   array1.map(x =&gt; x.map(y =&gt; (y._1, y._2 + <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">   <span class="comment">// foreach</span></span><br><span class="line">   array.foreach(println(_))</span><br><span class="line">   <span class="comment">// filter</span></span><br><span class="line">   array.filter(_ &gt; <span class="number">3</span>).foreach(println)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// flatten.map 和 flatmap 同等</span></span><br><span class="line">   <span class="keyword">val</span> words = <span class="type">List</span>(<span class="string">&quot;zhangsan zhangsan&quot;</span>, <span class="string">&quot;lisi lisi&quot;</span>, <span class="string">&quot;wangwu wangwu&quot;</span>)</span><br><span class="line">   words.map(x =&gt; x.split(<span class="string">&quot; &quot;</span>)).flatten.foreach(println)</span><br><span class="line">   words.flatMap(x =&gt; x.split(<span class="string">&quot; &quot;</span>)).foreach(println)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// reduce</span></span><br><span class="line">   println(array.reduce(_ - _))</span><br><span class="line">   println(array.reduceLeft(_ - _))</span><br><span class="line">   println(array.reduceRight(_ - _))</span><br><span class="line">   <span class="comment">// 带初始值 fold</span></span><br><span class="line">   println(array.fold(<span class="number">0</span>)(_ - _))</span><br><span class="line">   println(array.foldRight(<span class="number">0</span>)(_ - _))</span><br><span class="line"></span><br></pre></td></tr></table></figure>







      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/05/scala%E5%9F%BA%E7%A1%8002/" data-id="ckvl1q4l80003c9ghaprm5aai" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-scala基础" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2019/06/24/scala%E5%9F%BA%E7%A1%80/">scala基础01</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2019/06/24/scala%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2019-06-24T01:25:00.000Z" itemprop="datePublished">2019-06-24</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><h4 id="1-1-生成代码文档"><a href="#1-1-生成代码文档" class="headerlink" title="1.1.生成代码文档"></a>1.1.生成代码文档</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scaladoc HelloApp.scala</span><br></pre></td></tr></table></figure>
<h4 id="1-2-val-var"><a href="#1-2-val-var" class="headerlink" title="1.2. val var"></a>1.2. val var</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> 值</span><br><span class="line"><span class="keyword">var</span> 变量</span><br><span class="line"><span class="keyword">val</span>/<span class="keyword">var</span> 名称[:类型] = </span><br></pre></td></tr></table></figure>
<h4 id="1-3-数据类型"><a href="#1-3-数据类型" class="headerlink" title="1.3.数据类型"></a>1.3.数据类型</h4><p><img src="/img/image5566556.png" alt="upload successful"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否是某类型</span></span><br><span class="line">println(<span class="number">10.</span>isInstanceOf[<span class="type">Int</span>])</span><br><span class="line"> <span class="comment">// 类型转换</span></span><br><span class="line"><span class="number">10.</span>asInstanceOf[<span class="type">Double</span>]</span><br><span class="line"> </span><br><span class="line"><span class="keyword">val</span> money = <span class="number">23456</span></span><br><span class="line">printf(<span class="string">&quot;格式化输出:%d\n&quot;</span>, money)</span><br><span class="line">printf(<span class="string">&quot;格式化输出浮点数:%f\n&quot;</span>, math.<span class="type">Pi</span>)</span><br><span class="line">printf(<span class="string">&quot;格式化输出浮点数保留三位:%f\n&quot;</span>, math.<span class="type">Pi</span>)</span><br></pre></td></tr></table></figure>
<h4 id="1-4-常用写法-字符串插值-多行输出"><a href="#1-4-常用写法-字符串插值-多行输出" class="headerlink" title="1.4.常用写法 字符串插值 多行输出"></a>1.4.常用写法 字符串插值 多行输出</h4> <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串插值</span></span><br><span class="line">  <span class="keyword">val</span> name = <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">  <span class="keyword">val</span> age = <span class="number">26</span></span><br><span class="line">  println(<span class="string">s&quot;<span class="subst">$name</span>==&gt;<span class="subst">$&#123;age - 2&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 多行输出</span></span><br><span class="line">    <span class="keyword">val</span> weCome =</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">              |2222</span></span><br><span class="line"><span class="string">              |111</span></span><br><span class="line"><span class="string">              |33</span></span><br><span class="line"><span class="string">              |&quot;&quot;&quot;</span>.stripMargin</span><br><span class="line">        println(weCome)</span><br></pre></td></tr></table></figure>
<h4 id="1-5-条件判断"><a href="#1-5-条件判断" class="headerlink" title="1.5.条件判断"></a>1.5.条件判断</h4>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> (a % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">val</span> a = <span class="keyword">if</span>(x&gt;y) x <span class="keyword">else</span> y</span><br></pre></td></tr></table></figure>
<h4 id="1-5-循环"><a href="#1-5-循环" class="headerlink" title="1.5.循环"></a>1.5.循环</h4><pre><code> <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (a &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">     println(a)</span><br><span class="line">     a += <span class="number">1</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">val</span> s = <span class="string">&quot;asdfgh&quot;</span></span><br><span class="line"><span class="comment">// 增强for循环</span></span><br><span class="line"> <span class="keyword">for</span> (ele &lt;- s) &#123;</span><br><span class="line">     println(ele)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">3</span>) &#123;</span><br><span class="line">     println(i)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 和上面等价</span></span><br><span class="line"> <span class="keyword">for</span> (i &lt;- <span class="number">1.</span>to(<span class="number">3</span>)) &#123;</span><br><span class="line">     println(i)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 左闭右开区间[)</span></span><br><span class="line"> <span class="keyword">for</span> (i &lt;- <span class="number">1</span> until (<span class="number">3</span>)) &#123;</span><br><span class="line">     println(i)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 10以内的奇数</span></span><br><span class="line"> <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">10</span> <span class="keyword">if</span> i % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">     println(i)</span><br><span class="line"> &#125;</span><br><span class="line">    <span class="comment">// 九九乘方</span></span><br><span class="line">     <span class="keyword">for</span> (i&lt;<span class="number">-1</span> to <span class="number">9</span>;j&lt;<span class="number">-1</span> to i) &#123;</span><br><span class="line">     print(<span class="string">s&quot;<span class="subst">$i</span> * <span class="subst">$j</span> = <span class="subst">$&#123;i * j&#125;</span>\t&quot;</span>)</span><br><span class="line">     <span class="keyword">if</span> (i ==j) println()</span><br><span class="line"> &#125;</span><br><span class="line">     <span class="comment">// 将for循环里面的每个数承2</span></span><br><span class="line"> <span class="keyword">for</span> (i&lt;<span class="number">-1</span> to <span class="number">9</span>) <span class="keyword">yield</span> i * <span class="number">2</span></span><br><span class="line"> <span class="keyword">for</span> (i&lt;<span class="number">-1</span> to <span class="number">9</span>) <span class="keyword">yield</span> i * i</span><br><span class="line"></span><br><span class="line"> println(<span class="keyword">for</span> (ele&lt;- <span class="string">&quot;abcdefg&quot;</span>) <span class="keyword">yield</span> ele.toString.toUpperCase()+ele)</span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="1-6-退出break"><a href="#1-6-退出break" class="headerlink" title="1.6.退出break"></a>1.6.退出break</h4>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scala.util.control.<span class="type">Breaks</span>.&#123;<span class="keyword">break</span>, breakable&#125;</span><br><span class="line">        <span class="comment">// sacla 中的退出</span></span><br><span class="line">        breakable &#123;</span><br><span class="line">            <span class="keyword">for</span> (i &lt;- <span class="number">2</span> until (<span class="number">7</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="number">7</span> % i == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-7-方法定义-def"><a href="#1-7-方法定义-def" class="headerlink" title="1.7.方法定义 def"></a>1.7.方法定义 def</h4>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">max</span></span>(x:<span class="type">Int</span>,y:<span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">        <span class="keyword">if</span> (x&gt;y) x <span class="keyword">else</span> y</span><br><span class="line">    &#125;</span><br><span class="line">    println(max(<span class="number">1</span>,<span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可变长参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sum</span></span>(nums:<span class="type">Int</span>*):<span class="type">Int</span>= &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> (num&lt;-nums) &#123;</span><br><span class="line">            result+=num</span><br><span class="line">        &#125;</span><br><span class="line">        result</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    println(sum(<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">    <span class="comment">// 1到5相加</span></span><br><span class="line">    println(sum(<span class="number">1</span> to <span class="number">5</span>:_*))</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">printCourses</span></span>(course:<span class="type">String</span>*): <span class="type">Unit</span> = &#123;</span><br><span class="line">        println(course)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> array = <span class="type">Array</span>(<span class="string">&quot;hadoop&quot;</span>,<span class="string">&quot;scala&quot;</span>,<span class="string">&quot;Flink&quot;</span>)</span><br><span class="line">    printCourses(array:_*)</span><br></pre></td></tr></table></figure>
<h3 id="2-集合"><a href="#2-集合" class="headerlink" title="2.集合"></a>2.集合</h3>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala.collection</span><br><span class="line">scala.collection.immutable and scala.collection.mutable</span><br></pre></td></tr></table></figure>
<h4 id="2-1-array"><a href="#2-1-array" class="headerlink" title="2.1.array"></a>2.1.array</h4>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">val</span> a = <span class="type">Array</span>（<span class="number">1</span>，<span class="number">2</span>，<span class="number">3</span>，<span class="number">4</span>）</span><br><span class="line"><span class="keyword">val</span> b = <span class="type">Array</span>（<span class="number">5</span>，<span class="number">6</span>）</span><br><span class="line"><span class="comment">// 两个array相加并打印输出</span></span><br><span class="line">(a+b).foreach(println)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对array进行迭代</span></span><br><span class="line"><span class="keyword">for</span>（ele &lt;- c）&#123;</span><br><span class="line"> println(ele)</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">for</span>（ele &lt;- c.reverse）&#123;</span><br><span class="line"> println(ele)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可变数组</span></span><br><span class="line"><span class="type">ArrayBuffer</span></span><br><span class="line"><span class="comment">// 增加 insert</span></span><br><span class="line"><span class="comment">// 删除 remove</span></span><br><span class="line"><span class="comment">// 从尾部删除 trimEnd(2)</span></span><br><span class="line">max min sum</span><br></pre></td></tr></table></figure>
<h4 id="2-2-set"><a href="#2-2-set" class="headerlink" title="2.2.set"></a>2.2.set</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Set</span>() 无序 去重</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-3-Tuple"><a href="#2-3-Tuple" class="headerlink" title="2.3.Tuple"></a>2.3.Tuple</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">（.....）</span><br><span class="line"><span class="comment">// 最多放22个元素</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> a = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="comment">// 遍历</span></span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until (a.productArity)) &#123;</span><br><span class="line">      println(a.productElement(i))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (ele &lt;- a.productIterator) &#123;</span><br><span class="line">      println(ele)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 对偶元组</span></span><br><span class="line">    <span class="keyword">val</span> t1 = (<span class="string">&quot;张三&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>)</span><br><span class="line">    <span class="comment">// 两者交换位置</span></span><br><span class="line">    println(t1.swap)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 常用灵活写法 (输出结果为tuple)</span></span><br><span class="line">    <span class="keyword">val</span> array: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>[<span class="type">Int</span>](<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>]) = &#123;</span><br><span class="line">      (array.max, array.min, array.sum / array.length)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tuple = method(array)</span><br><span class="line">    println(tuple._1)</span><br><span class="line">    println(tuple._2)</span><br><span class="line">    println(tuple._3)</span><br><span class="line">    <span class="keyword">val</span> (max, min, avg) = method(array)</span><br><span class="line">    println(max)</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-4-Map"><a href="#2-4-Map" class="headerlink" title="2.4.Map"></a>2.4.Map</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">val</span> map1 = <span class="type">Map</span>(<span class="string">&quot;zhangsan&quot;</span> -&gt; <span class="number">19</span>, <span class="string">&quot;lisi&quot;</span> -&gt; <span class="number">23</span>)</span><br><span class="line"><span class="comment">// 遍历</span></span><br><span class="line"><span class="keyword">for</span>((k,v)&lt;-map1) &#123;</span><br><span class="line">  println((k, v))</span><br><span class="line">&#125;</span><br><span class="line">map1.foreach(println)</span><br><span class="line"><span class="comment">// 获取所有key</span></span><br><span class="line"><span class="keyword">for</span> (ele &lt;-map1.keys) &#123;</span><br><span class="line">  println(ele)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取所有value</span></span><br><span class="line"><span class="keyword">for</span> (ele &lt;-map1.values) &#123;</span><br><span class="line">  println(ele)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据key取value</span></span><br><span class="line">println(map1.getOrElse(<span class="string">&quot;lisi&quot;</span>, <span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<h4 id="2-5-Queue"><a href="#2-5-Queue" class="headerlink" title="2.5.Queue"></a>2.5.Queue</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">val q1: mutable.Queue[Int] &#x3D; new mutable.Queue[Int]()</span><br><span class="line">q1 +&#x3D; (20,39)</span><br><span class="line">println(q1)</span><br><span class="line">println(q1.dequeue())</span><br><span class="line">println(q1.head)</span><br><span class="line">q1.tail</span><br><span class="line">q1.last</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-6-List"><a href="#2-6-List" class="headerlink" title="2.6.List"></a>2.6.List</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="type">Nil</span> 是空<span class="type">List</span>集合</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-7-常用集合"><a href="#2-7-常用集合" class="headerlink" title="2.7.常用集合"></a>2.7.常用集合</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">ArraBuffer</span></span><br><span class="line"><span class="type">Map</span>/<span class="type">HashMap</span></span><br><span class="line"><span class="type">List</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>







      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/06/24/scala%E5%9F%BA%E7%A1%80/" data-id="ckvl1q4l70001c9gh41x78ng8" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-MapReduce" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2019/05/08/MapReduce/">MapReduce</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2019/05/08/MapReduce/" class="article-date">
  <time datetime="2019-05-08T13:59:00.000Z" itemprop="datePublished">2019-05-08</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><p>map:映射<br>将一组数据按照规则 映射为一组<br>数据条数不会发生变化</p>
<p>例如：<br>select age+1 from table1;</p>
<p>reduce:规约 汇总 数据条数会发生变化</p>
<p>例如：<br>group by</p>
<p>shuffle 洗牌 数据根据key进行网络传输 规整到一起，按规则计算</p>
<p>shuffle 因为会网络传输，会拉长计算的时间，能不shuffle就不shuffle</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-架构"><a href="#2-架构" class="headerlink" title="2.架构"></a>2.架构</h2><p>计算：cpu+内存</p>
<p>ResourceManager(rm) 主<br>ApplicationsManager 应用管理器 作业 程序<br>ResourceScheduler     资源管理器 </p>
<p>NodeManager(nm) 从</p>
<p>container</p>
<hr>
<p>Linux两个机制：<br>1.oom-killer机制</p>
<p>当Linux服务器某个进程使用内存超标 Linux机器为了保护自己，主动杀死进程释放内存</p>
<p>2./tmp 目录<br>30天自动删除机制</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/05/08/MapReduce/" data-id="ckvl1q4l80002c9gheaxd7wot" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-离线数据仓库建设" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2018/05/12/%E7%A6%BB%E7%BA%BF%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E5%BB%BA%E8%AE%BE/">离线数据仓库建设</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2018/05/12/%E7%A6%BB%E7%BA%BF%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E5%BB%BA%E8%AE%BE/" class="article-date">
  <time datetime="2018-05-12T15:37:00.000Z" itemprop="datePublished">2018-05-12</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <h2 id="离线数仓项目搭建流程"><a href="#离线数仓项目搭建流程" class="headerlink" title="离线数仓项目搭建流程"></a>离线数仓项目搭建流程</h2><p>项目背景:电商<br>分享重点:<br>离线数仓演进过程当中遇到的问题&amp;解决方案/思路<br>数据库&amp;数据仓库 范式建模  维度建模<br>维度表设计<br>事实表设计<br>kylin<br>mysql  hive kylin 展示</p>
<h3 id="1-离线数仓演进过程"><a href="#1-离线数仓演进过程" class="headerlink" title="1.离线数仓演进过程"></a>1.离线数仓演进过程</h3><h4 id="1-1-第一阶段"><a href="#1-1-第一阶段" class="headerlink" title="1.1.第一阶段"></a>1.1.第一阶段</h4><p>统计需求  mysql<br>业务系统：CRM系统、ERP系统、交易系统、商品系统、供应商系统….<br>随着发展 数据去决策<br>交易系统  order库<br>商品系统  item库<br>mysql  –&gt; hive –&gt; excel给到业务方<br>问题：1.烟囱式开发/重复开发 取数<br>延伸需求：建立数仓  –&gt; 数仓架构设计/表名规范/分层的设计 搭建各个主题域的中间层</p>
<h4 id="1-2-第二阶段"><a href="#1-2-第二阶段" class="headerlink" title="1.2.第二阶段"></a>1.2.第二阶段</h4><p>问题:<br>1.数据量上来之后 数据抽取的操作十分耗费时间 ===&gt; 如何去选择最优的一个数据抽取/存储策略</p>
<p>2.ETL任务 脚本跑在服务器上面</p>
<p>每天凌晨 定时在服务器 pull   push</p>
<p>如果修改代码  忘记提交了  ==&gt; 凌晨任务跑不来</p>
<p>解决方式:<strong>平台化 ETL开发平台  发布ETL任务</strong></p>
<p>3.调度问题 crontab 遇到上下游任务有依赖 a任务依赖b b任务依赖c<br>            c  1<br>            b  2 ==》 4<br>            a  3</p>
<p><strong>依赖调度 azkaban airflow DolphinScheduler</strong></p>
<h4 id="1-3-第三阶段"><a href="#1-3-第三阶段" class="headerlink" title="1.3.第三阶段"></a>1.3.第三阶段</h4><p>问题:<br>1.随着业务发展  业务系统需要进行一定程度的改造<br>            父子订单  购物车  a b c三个商品==&gt;order_id   子订单<br>                      购物车  trade_id  父订单<br>                      退款只是支持到trade维度<br>            数仓当中有一张order表 下游<br>            批次 有批次  一品多商<br>                 无批次  一品一商<br>            数据血缘</p>
<p>2.业务方质疑你的数据不准<br>可能原因:数据口径不统一  我真的取错数据了(sql写错了)<br>            gmv 下单金额+优惠券金额<br>                 下单金额</p>
<p>解决方案:<strong>指标中心</strong></p>
<p>数据抽取挂了 分表64张  60张 ==&gt; </p>
<p>解决方案:<strong>数据质量中心(DQC) 监控每天数据条数变化  对应指标</strong></p>
<p>3.任务跑的慢 sql写的不规范</p>
<p>hive分区表<br>a 365分区<br>b 365分区</p>
<p>需求：多维分析  ==&gt; kylin+BI系统<br>     数据血缘 + 指标中心 + 数仓表(数据字典) ==&gt; 元数据中心<br>     BI多了起来 取数 desc xx hue</p>
<h4 id="1-4-第四阶段"><a href="#1-4-第四阶段" class="headerlink" title="1.4.第四阶段"></a>1.4.第四阶段</h4><p>问题：集群稳定性 cdh</p>
<p>采集各个系统(数据团队)的关键数据 ==&gt; 图表 离线任务运行时长</p>
<pre><code> 枚举 trade_type 10 11 12...
      0:xxx  1:yyy 2:zzz ....
      case when
      枚举中心  预警、界面 k-v ==&gt; 码表
</code></pre>
<h3 id="2-如何去做数仓架构设计"><a href="#2-如何去做数仓架构设计" class="headerlink" title="2.如何去做数仓架构设计"></a>2.如何去做数仓架构设计</h3><pre><code>数据抽取 sqoop/datax
 数仓分层
     ODS operational data store
         最接近数据源当中的一层 尽量保持和源端的数据格式一样
     DW
         DWD  该层保持和ODS层一样的数据粒度  数据清洗(过滤、日期格式转换 时间戳--&gt;yyyy-MM-dd等)的操作
         DWM  数据中间层 提升数仓公共指标的复用性 减少重复加工
              交易域 商品域 CRM域 门店域 流量域...
              下单商品  下单金额 下单时间  支付状态 ...
         DWS  生成字段比较多的宽表 提供给后续的业务查询
              select xxx from tbl where dayid=&#39;xxx&#39; group by xx
     APP 数据应用层
            report(报表)  严禁读取ods dwd层 中间层建设不完善
         kylin数据
         数据加工st_xxx
     DIM维表
         数仓通用的维表  时间/地区/类目/商品....
 数据回流  sync_xxxx脚本 mysql提供给业务系统

 数仓表名、字段名 命名规范
     数仓里的表在天上飞
     数仓表名和ETL任务名 保持一致 hive -v -e &quot;insert xxxx select xxxx&quot;
     ods_t_item_d  ods_t_item_d.sh
     st_itm_gmv_d  st_itm_gmv_d.sh
     sync_st_itm_gmv_d.sh select xxx   sqoop命令
 
     _d天更新
     _m月更新
     _h按小时更新
 
     _i增量表 数据是增量
     _s拉链表
     ODS层    层级_业务库_mysql表名_d
              ods_trade_pay_xxx_d/i
     中间层   层级_主题域_业务过程_[/d/h/m...]
              dws层 _1d 统计日当天的汇总数据
                    _nd 统计近n天的汇总数据
                    _mtd 统计当月累计到统计日的汇总数据
                    _td  统计的就是历史全量数据
                    _dth
     维表     dim_维度名称_d 每日全量表
              dim_维度名称   全量表
              dim_维度名称_ds 拉链表 极限存储表
 
 技术选型
     数据抽取  sqoop/datax
     数仓      Hive    impala Greenplum
     传统数仓  oracle
     数据回流  sqoop/datax
</code></pre>
<p> 数据平台架构图(离线)</p>
<p><img src="/img/hdkaslgfi6d.png" alt="upload successful"></p>
<h3 id="3-数据库-amp-数据仓库"><a href="#3-数据库-amp-数据仓库" class="headerlink" title="3.数据库&amp;数据仓库"></a>3.数据库&amp;数据仓库</h3><pre><code>范式
第零范式  无重复数据
第一范式  满足属性不可分
第二范式  在第一范式的基础上更进一步，确保数据库的表当中每一个字段都只和主键相关
第三范式  确保数据表中的每一列数据都和主键直接相关，而不能间接相关
          在第二范式的基础上 属性只直接依赖主键

数据仓库和范式之间存在着一种什么样的关系
维度建模中的星型模型  在范式理论上是符合第二范式
            雪花模型  星型模型和雪花模型最大区别在于  维度表是否和事实表直接相连

有冗余的事实表
    将一些维度信息，比如说用户信息、商品信息 冗余到订单事实表中
    在范式理论上是符合第一范式

数据库和数据仓库各自的侧重点
    对于绝大多数的数据仓库设计来说，一般情况下都不会去考虑是否满足第几范式
    数据库 设计 联机事务处理  OLTP(on-line transaction processing) 各种的增删改查操作
    数据仓库    联机分析处理  OLAP  面向日常数据分析  数据插入和查询，基本上不会去涉及数据的删除和修改操作

数据库面向事务的设计  数仓面向主题的设计
业务系统              分系系统
order_id              历史数据
尽量避免冗余          刻意的去引入冗余操作
</code></pre>
<p> 第一范式<br><img src="/img/diyiimage.png" alt="upload successful"></p>
<p>第二范式<br><img src="/img/diewreree.png" alt="upload successful"></p>
<p>第三范式<br><img src="/img/disainaaaaade.png" alt="upload successful"></p>
<h3 id="4-维度表"><a href="#4-维度表" class="headerlink" title="4.维度表"></a>4.维度表</h3><h4 id="4-1维度的基本概念"><a href="#4-1维度的基本概念" class="headerlink" title="4.1维度的基本概念"></a>4.1维度的基本概念</h4><pre><code>度量 指标  称为 事实
对于一些环境的描述 称为 维度
select
  item,      --&gt; 维度
  sum(gmv)   --&gt; 聚合指标 
from tbl
group by item
分析交易过程  商品、时间、买家(客户 消费者)、卖家(供应商)  ==&gt; 用于分析指标所需要的一个多样的环境

维度获取方式
    1.业务定义的  
    2.数据中去获取
</code></pre>
<h3 id="4-2-如何去设计一张维度表"><a href="#4-2-如何去设计一张维度表" class="headerlink" title="4.2.如何去设计一张维度表"></a>4.2.如何去设计一张维度表</h3><pre><code>1.选择维度  商品 时间 地区...
2. select
    xxx
   from
   (
         select xx
   ) as t1
   left join
   ...
   确定一张主维表  t_item
3.确定相关/需要关联的维表
  spu  店铺  商家  类目
  sku
4.确定维度属性
  1.尽可能的丰富  下游在使用我们的维度表更方便 统计分析类的操作
    ID Name
  2.字段 作为维度 具体的事实
    通常情况下用于查询的约束条件(where) 或者  用于分组统计(group by)
    通常参与实际的度量计算  事实
</code></pre>
<p>维度的层次结构<br>    上卷  下钻</p>
<p>类目、地区、品牌是否应该全部存在于一张商品维表当中？<br>规范化<br>    对于大多数的OLTP系统来说，底层的数据模型设计时 通常会采用规范化的方式<br>    将一些维度属性 移到 他们自身所属的表当中，删除冗余数据</p>
<pre><code>类目 商品 ==&gt; 1:n
</code></pre>
<p>反规范化<br>    退化维度  冗余一部分数据  一张平表  打平<br>    易用性比较高  存储成本升高了</p>
<p>规范化&amp;反规范化.png<br><img src="/img/gjdsjka34f.png" alt="upload successful"></p>
<p>一致性维度<br>    流量   item pv uv<br>    交易   item gmv<br>    数据探查(交叉探查):将不同业务域(数据域)的商品维度的数据给结合到一块进行展示<br>    item pv uv gmv</p>
<pre><code>商品维度 流量  a b c
         交易  b c d e f g
时间维度 timestamp
         yyyy-MM-dd

针对这类问题 如何去保证维度的一致性
    共享维度表
</code></pre>
<p>维度整合&amp;拆分<br>    数据仓库的定义：面向主题的、集成的数据集合<br>    表现形式&amp;注意点：<br>        表名、字段名 的 命名规范的统一<br>                        字段类型的统一<br>        业务含义相同的表进行统一，高内聚、低耦合的设计理念<br>            源端 数据形式 差异较小的表进行整合<br>            源端 数据形式 差异很大的表进行拆分</p>
<pre><code>        主从表设计
        直接合并 a b 2个bu
            1 2 3 类目
                  a
                  b

            a类目 b类目
        不合并
    直接合并
        垂直整合  类目   bu字段
                  a
                  b
                  c
                  ..
        水平整合  打平
</code></pre>
<p>维度拆分<br>    水平拆分</p>
<pre><code>维度设计过程当中，可能会遇到的问题：
    1.某些维表属性的来源表 产出数据的时间比较早  4   a
      某些维表属性的来源表 产出数据的时间比较晚  12  b
                                                     c
    2.某些维表的属性/字段  热度比较高  使用比较频繁
      某些维表的属性/字段  热度比较低  使用比较少
    3.某些维表的属性/字段  经常会变化/不怎么变(稳定)
主从表 主表 重要的维度属性

设计原则
    扩展性  粒度不一样  高内聚 低耦合
    易用性
    效率
</code></pre>
<p>历史数据的归档<br>    归档到oss去<br>    归档策略1：前台商品展示的策略：商品状态 商品是否被删除 更新策略<br>               ==&gt; 对应的下单信息就不会有这批商品<br>               前台商品的归档策略<br>               问题：实现后 维护成本很高<br>    归档策略2：binlog<br>    ===&gt; 了解一下<br>    京东 sku 1.5T  250亿  15亿</p>
<pre><code>归档策略3：自定义  通过设置数仓表的生命周期
           ods 3    6.7==》6 5 4
                      8==》7 6 5
           dwd 93
           dw  93
           ...
           report 历史全部保留
           增量表 历史全部保留
</code></pre>
<p>缓慢变化维<br>    数仓的重要特点 就是 反应了数据的历史变化<br>    如何去处理维度的变化是整个维度设计过程中的最重要工作<br>    维度的变化实际上是不怎么频繁的<br>    第一种处理方式：重写维度值<br>    第二种处理方式：新增维度行<br>    第三种处理方式：新增维度列<br>    实际生产使用 看场景</p>
<p>快照维表<br>    快照：某个时间点的状态<br>    快照的周期：多久去获取一次数据  天  h 1min<br>    问题：按天获取快照，如何获取？<br>    item  分区表，以天进行分区<br>    mysql<br>    0601   item1   item<br>    0602   item2   item<br>    …    …     …<br>    0607   item7   item<br>    item表每天都在insert 和 update  拓展：delete?  如果删除的话 是物理删除还是逻辑删除?  is_deleted<br>    ==》<br>    按天进行数据抽取的操作 T+1 数据是延迟1天<br>    0602的凌晨1点  去抽取  mysql端截止到0601 24:00  create_time  update_time(edit_time) dt=20200601<br>    0603<br>    0604<br>    …<br>    0607<br>    …<br>    抽取是全量抽取</p>
<pre><code>这样的构建方式是否会有问题？
    第一个性能问题：存储
    1张表 365个分区
    n张表 n*365
    (1+2+3+4+5+6+7+...+365) * 3 or 2  hdfs是3副本(2副本)

    第二个性能问题：抽取性能  业务库的压力
    sqoop抽取 抽取慢 -m往上加  一定程度上去加快整体的抽取速率
    凌晨 对多个实例 进行抽取
           1个实例  会有多个mysql库
           1个库    会有多张mysql表
           DBA团队
</code></pre>
<p>增量抽取&amp;merge<br>极限存储(拉链表)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/05/12/%E7%A6%BB%E7%BA%BF%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E5%BB%BA%E8%AE%BE/" data-id="ckvl1q4l90004c9gh26h9cb6m" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-离线数仓建设2" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2018/05/12/%E7%A6%BB%E7%BA%BF%E6%95%B0%E4%BB%93%E5%BB%BA%E8%AE%BE2/">离线数仓建设2</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2018/05/12/%E7%A6%BB%E7%BA%BF%E6%95%B0%E4%BB%93%E5%BB%BA%E8%AE%BE2/" class="article-date">
  <time datetime="2018-05-12T06:45:00.000Z" itemprop="datePublished">2018-05-12</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <h2 id="1-增量数据同步"><a href="#1-增量数据同步" class="headerlink" title="1.增量数据同步"></a>1.增量数据同步</h2><h3 id="1-1-增量抽取-merge到全量的过程"><a href="#1-1-增量抽取-merge到全量的过程" class="headerlink" title="1.1.增量抽取+merge到全量的过程"></a>1.1.增量抽取+merge到全量的过程</h3><p>ods:增量（每个时间分区）</p>
<p>dwd:全量（每个时间分区）</p>
<p>增量数据抽取条件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">where</span> (create_time <span class="operator">&gt;=</span> <span class="number">2017</span><span class="number">-06</span><span class="number">-01</span> <span class="keyword">or</span> update_time <span class="operator">&gt;=</span> <span class="number">2017</span><span class="number">-06</span><span class="number">-01</span>)</span><br></pre></td></tr></table></figure>
<p>ods层增量数据合并到dwd层全量数据</p>
<p>1.确定关联键唯一（一般用id）</p>
<p>2.</p>
<p>全量表</p>
<p>left join</p>
<p>增量表 on 全量表.id = 增量表.id</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span></span><br><span class="line"><span class="comment">--全量表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dwd_order_d(</span><br><span class="line">pay_day string,</span><br><span class="line">trade_no string,</span><br><span class="line">phone string,</span><br><span class="line">pay_amount <span class="type">decimal</span>(<span class="number">18</span>,<span class="number">2</span>),</span><br><span class="line">pay_status <span class="type">int</span>,</span><br><span class="line">update_time string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br><span class="line"></span><br><span class="line"><span class="comment">--增量表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ods_order_di(</span><br><span class="line">pay_day string,</span><br><span class="line">trade_no string,</span><br><span class="line">phone string,</span><br><span class="line">pay_amount <span class="type">decimal</span>(<span class="number">18</span>,<span class="number">2</span>),</span><br><span class="line">pay_status <span class="type">int</span>,</span><br><span class="line">update_time string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br><span class="line"><span class="number">2.</span>数据导入</span><br><span class="line">order_his.txt</span><br><span class="line"><span class="number">2017</span><span class="number">-06</span><span class="number">-01</span>,<span class="number">001</span>,<span class="number">111111</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">2017</span><span class="number">-06</span><span class="number">-01</span></span><br><span class="line"><span class="number">2017</span><span class="number">-06</span><span class="number">-01</span>,<span class="number">002</span>,<span class="number">222222</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2017</span><span class="number">-06</span><span class="number">-01</span></span><br><span class="line"><span class="number">2017</span><span class="number">-06</span><span class="number">-01</span>,<span class="number">003</span>,<span class="number">333333</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">2017</span><span class="number">-06</span><span class="number">-01</span></span><br><span class="line"><span class="number">2017</span><span class="number">-06</span><span class="number">-01</span>,<span class="number">004</span>,<span class="number">444444</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">2017</span><span class="number">-06</span><span class="number">-01</span></span><br><span class="line"></span><br><span class="line">order_increment.txt</span><br><span class="line"><span class="number">2017</span><span class="number">-06</span><span class="number">-01</span>,<span class="number">002</span>,<span class="number">222222</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">2017</span><span class="number">-06</span><span class="number">-02</span></span><br><span class="line"><span class="number">2017</span><span class="number">-06</span><span class="number">-01</span>,<span class="number">004</span>,<span class="number">444444</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">2017</span><span class="number">-06</span><span class="number">-02</span></span><br><span class="line"><span class="number">2017</span><span class="number">-06</span><span class="number">-02</span>,<span class="number">005</span>,<span class="number">444444</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">2017</span><span class="number">-06</span><span class="number">-02</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/data/order_his.txt&#x27;</span> overwrite <span class="keyword">into</span> <span class="keyword">table</span> dwd_order_d</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/data/order_increment.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_order_di</span><br><span class="line"></span><br><span class="line">写<span class="keyword">sql</span>合并：</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dwd_order_d</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  a.pay_day,</span><br><span class="line">  a.trade_no,</span><br><span class="line">  a.phone,</span><br><span class="line">  a.pay_amount,</span><br><span class="line">  a.pay_status,</span><br><span class="line">  a.update_time</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">   <span class="keyword">select</span></span><br><span class="line">     pay_day,</span><br><span class="line">     trade_no,</span><br><span class="line">     phone,</span><br><span class="line">     pay_amount,</span><br><span class="line">     pay_status,</span><br><span class="line">     update_time</span><br><span class="line">   <span class="keyword">from</span> dwd_order_d</span><br><span class="line">) <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">(</span><br><span class="line">   <span class="keyword">select</span></span><br><span class="line">     pay_day,</span><br><span class="line">     trade_no,</span><br><span class="line">     phone,</span><br><span class="line">     pay_amount,</span><br><span class="line">     pay_status,</span><br><span class="line">     update_time</span><br><span class="line">   <span class="keyword">from</span> ods_order_di</span><br><span class="line">) <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">on</span> a.trade_no <span class="operator">=</span> b.trade_no</span><br><span class="line"><span class="keyword">where</span> b.trade_no <span class="keyword">is</span> <span class="keyword">null</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  pay_day,</span><br><span class="line"> trade_no,</span><br><span class="line"> phone,</span><br><span class="line"> pay_amount,</span><br><span class="line"> pay_status,</span><br><span class="line"> update_time</span><br><span class="line"><span class="keyword">from</span> ods_order_di</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>增量抽取+merge到全量的过程</p>
<p>1.抽取性能提升  业务库的压力减少了</p>
<p>2.数仓中的数据变化</p>
<p>dwd层 一直都是全量，是没减少的<br>ods层 是减少了  原先天天全量抽取  现在天天增量抽取  但是不明显<br>   因为ods层只保留3天的数据</p>
<h3 id="1-2-拉链表"><a href="#1-2-拉链表" class="headerlink" title="1.2.拉链表"></a>1.2.拉链表</h3><h4 id="1-2-1-拉链表介绍"><a href="#1-2-1-拉链表介绍" class="headerlink" title="1.2.1.拉链表介绍"></a>1.2.1.拉链表介绍</h4><p>1.多了start_date和end_date这2个字段  标识了所在记录的生命周期</p>
<p>拉链表的意义是什么</p>
<p>方式一：全量抽取   ods+dwd 按天分区 天天全量</p>
<p>dwd数据量(一年数据为例):    <strong>365*每天全量数据</strong></p>
<p>方式二：增量抽取 + merge到全量表    dwd层时 按天分区 天天全量</p>
<p>dwd数据量(一年数据为例):<strong>1<em>全量数据 + 364</em>每天全量的数据</strong></p>
<p>方式三：拉链表  最大的作用就是 降低了非常多的存储<br>dwd数据量(一年数据为例):<strong>初始化拉链表时的全量数据 + 天<em>更新的数据（1</em>全量数据 + 364*每天更新的数据）</strong></p>
<p>拉链表 能够兼顾一种场景 业务上要看历史上某个时刻的数据</p>
<h4 id="1-2-2-拉链表实现"><a href="#1-2-2-拉链表实现" class="headerlink" title="1.2.2.拉链表实现"></a>1.2.2.拉链表实现</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--ods层的初始化全量表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ods_order_d(</span><br><span class="line">pay_day string,</span><br><span class="line">trade_no string,</span><br><span class="line">phone string,</span><br><span class="line">pay_amount <span class="type">decimal</span>(<span class="number">18</span>,<span class="number">2</span>),</span><br><span class="line">pay_status <span class="type">int</span>,</span><br><span class="line">update_time string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br><span class="line">数据导入：</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/data/order_his.txt&#x27;</span> overwrite <span class="keyword">into</span> <span class="keyword">table</span> ods_order_d</span><br><span class="line"></span><br><span class="line"><span class="comment">--ods层的订单更新表</span></span><br><span class="line">ods_order_di</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 拉链表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dwd_order_ds(</span><br><span class="line">pay_day string,</span><br><span class="line">trade_no string,</span><br><span class="line">phone string,</span><br><span class="line">pay_amount <span class="type">decimal</span>(<span class="number">18</span>,<span class="number">2</span>),</span><br><span class="line">pay_status <span class="type">int</span>,</span><br><span class="line">start_date string,</span><br><span class="line">end_date string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br><span class="line"></span><br><span class="line">第一步：初始化拉链表</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dwd_order_ds</span><br><span class="line">selectpay_day,trade_no,phone,pay_amount,pay_status,<span class="string">&#x27;2018-06-01&#x27;</span> <span class="keyword">as</span> start_date,<span class="string">&#x27;9999-12-31&#x27;</span> <span class="keyword">as</span> end_date <span class="keyword">from</span> ods_order_d;</span><br><span class="line"></span><br><span class="line">第二步：</span><br><span class="line">	<span class="number">1.</span>对于历史上已经被更新掉的数据  end_date 要从<span class="number">9999</span><span class="number">-12</span><span class="number">-31</span>改为失效的那一天日期</span><br><span class="line">	<span class="number">2.</span>要将新增的记录 <span class="keyword">or</span> 被更新的记录 给<span class="keyword">insert</span>进去  同时将对应的<span class="keyword">start</span> <span class="keyword">end</span>给赋值</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dwd_order_ds</span><br><span class="line"><span class="keyword">select</span> t.<span class="operator">*</span> <span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> a.pay_day,a.trade_no,a.phone,a.pay_amount,a.pay_status,a.start_date,<span class="keyword">case</span> <span class="keyword">when</span> a.end_date<span class="operator">=</span><span class="string">&#x27;9999-12-31&#x27;</span> <span class="keyword">and</span> b.trade_no <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">then</span> <span class="string">&#x27;2018-06-01&#x27;</span> <span class="keyword">else</span> a.end_date <span class="keyword">end</span> <span class="keyword">as</span> end_date <span class="keyword">from</span> dwd_order_ds <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span> ods_order_di <span class="keyword">as</span> b <span class="keyword">on</span> a.trade_no <span class="operator">=</span> b.trade_no</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> c.pay_day,c.trade_no,c.phone,c.pay_amount,c.pay_status,</span><br><span class="line"><span class="string">&#x27;2018-06-02&#x27;</span> <span class="keyword">as</span> start_date,<span class="string">&#x27;9999-12-31&#x27;</span> <span class="keyword">as</span> end_date <span class="keyword">from</span> ods_order_di <span class="keyword">as</span> c) <span class="keyword">as</span> t</span><br></pre></td></tr></table></figure>

<h4 id="1-2-3-拉链表缺点"><a href="#1-2-3-拉链表缺点" class="headerlink" title="1.2.3.拉链表缺点"></a>1.2.3.拉链表缺点</h4><h5 id="1-上游数据加字段问题"><a href="#1-上游数据加字段问题" class="headerlink" title="1.上游数据加字段问题"></a>1.上游数据加字段问题</h5><p>mysql端:a字段在2018-06-01加上了 而且a字段很重要 业务统计要用的</p>
<p>hive端  a字段  2020-06-07才知道 </p>
<p>1-7号  关于a字段的状态 丢了？1个月后 业务统计又恰好需要历史状态</p>
<p>mysql业务库上,要加的这个字段a,对于历史数据来说他是有默认值的</p>
<p>hive端 对于拉链表来说  历史的数据也需要有默认值</p>
<p><strong>解决方式</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite xxx</span><br><span class="line"><span class="keyword">select</span> a,b,</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span> <span class="keyword">as</span> new_column</span><br><span class="line"><span class="keyword">from</span> dwd_order_ds</span><br></pre></td></tr></table></figure>

<h5 id="2-上游数据出现脏数据"><a href="#2-上游数据出现脏数据" class="headerlink" title="2.上游数据出现脏数据"></a>2.上游数据出现脏数据</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">以订单数据为例  变化周期是固定   确定业务周期 这些数据过了这个周期是不会再变了</span><br><span class="line">  数据结转  dt(分区字段)  过期  历史  活跃</span><br><span class="line">  	过期   所有生命周期已经无效了的数据</span><br><span class="line">  	历史   不会再做任何变更的数据</span><br><span class="line">  	活跃   在固定业务周期内 还会做变化的数据</span><br></pre></td></tr></table></figure>
<h5 id="3-注意点"><a href="#3-注意点" class="headerlink" title="3.注意点"></a>3.注意点</h5><p>关联键 一定要和业务开发 确认好 是否能够确保关联的时候不会出问题  </p>
<h5 id="4-拉链表优化"><a href="#4-拉链表优化" class="headerlink" title="4.拉链表优化"></a>4.拉链表优化</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>存储格式  列式存储 orc</span><br><span class="line"><span class="number">2.</span>指定分区字段  查询能做分区裁剪</span><br><span class="line">		dt</span><br><span class="line">业务上的时间  pay_day,update_time</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/05/12/%E7%A6%BB%E7%BA%BF%E6%95%B0%E4%BB%93%E5%BB%BA%E8%AE%BE2/" data-id="ckvl1q4l90005c9gh50gbcte9" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
  </article>
  

  
</section>
</div>

    <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
  <li><i class="fe fe-bar-chart"></i> <span id="busuanzi_value_site_pv"></span></li>
  
  <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>个人博客 &copy; 2021</li>
      
        <li>京ICP备17054916号-2</li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="个人博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">About</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/copybtn.js"></script>






<script src="/js/ocean.js"></script>

</body>

</html>